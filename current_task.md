# REF-007: Улучшение типобезопасности KeywordDictionary

## Контекст
В ходе анализа архитектуры выявлены проблемы с типобезопасностью в KeywordDictionary, несмотря на существующие проверки. В коде есть `Hotfix` комментарии с проверками `isinstance(entry, str)` вместо ожидаемого `KeywordEntry`, что может привести к ошибкам времени выполнения. Также выявлена проблема с несогласованностью в обработке лемматизации между KeywordDictionary и TransactionCategoryClassifier.

## TDD Стратегия
Тестовый файл: `tests/test_keyword_dictionary_type_safety.py`

## Инструменты для исследования
- `codebase_search` с запросом "KeywordDictionary type safety isinstance hotfix"
- Изучить файл `models/keyword_dictionary.py`, особенно методы с валидацией типов
- Проверить все места использования `_validate_keyword_entry`

## План действий
1. [x] Создать `tests/test_keyword_dictionary_type_safety.py` (RED)
2. [x] Идентифицировать все места, где могут возникать строки вместо KeywordEntry
3. [x] Улучшить валидацию типов в методах поиска
4. [x] Устранить возможные пути, по которых строки могут попасть в словари
5. [x] Создать централизованный модуль для лемматизации и унифицировать его использование
6. [x] Добавить тесты для проверки корректности обработки лемматизации
7. [x] Проверить, что все методы обеспечивают целостность типов

## BACKLOG
- [ ] **REF-003** Стандартизация Dependency Injection в хендлерах
- [ ] **REF-004** Консолидация клиентов Google Sheets
- [ ] **REF-006** Улучшение системы миграций
- [ ] **REF-008** Улучшение разделения ответственности в хендлерах