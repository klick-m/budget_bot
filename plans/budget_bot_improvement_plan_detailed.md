# Детальный план улучшений для проекта Budget Bot

## Обзор текущей архитектуры

Проект Budget Bot реализует архитектуру на основе микросервисного подхода с разделением на слои:
- **Handlers** - слой представления, обрабатывает входящие сообщения от Telegram
- **Services** - бизнес-логика и фасады для работы с различными компонентами
- **Models** - структуры данных и логика словаря ключевых слов
- **Sheets** - интеграция с Google Sheets
- **Utils** - вспомогательные функции и утилиты

## Декомпозиция на атомарные задачи

### Фаза 1: Стабилизация (1-2 недели)

#### Задача 1.1: Исправление проблем с целостностью данных в KeywordDictionary
**Описание**: Устранение `Hotfix` проверок типов, которые могут привести к ошибкам времени выполнения
**Файлы**: models/keyword_dictionary.py
**Шаги**:
1. Заменить все проверки `isinstance(entry, str)` на строгую типизацию
2. Убедиться, что все элементы в словарях имеют тип `KeywordEntry`
3. Добавить строгие типизированные проверки
4. Проверить все места использования словарей ключевых слов

#### Задача 1.2: Устранение проблем с асинхронностью
**Описание**: Исправление использования `asyncio.run()` внутри синхронных функций
**Файлы**: models/keyword_dictionary.py
**Шаги**:
1. Удалить использование `asyncio.run()` внутри синхронных функций
2. Переписать метод `update_from_sheets()` для корректной работы в асинхронном контексте
3. Обеспечить правильную обработку асинхронных операций
4. Проверить все вызовы асинхронных функций

#### Задача 1.3: Стандартизация Dependency Injection
**Описание**: Унификация подхода к внедрению зависимостей для улучшения тестируемости
**Файлы**: handlers/receipts.py, handlers/manual.py, handlers/smart_input.py
**Шаги**:
1. Удалить устаревшие комментарии `# Service injected` и `# Checks removed`
2. Использовать единый механизм внедрения зависимостей через `dp.workflow_data`
3. Обновить все хендлеры для использования стандартного подхода
4. Проверить и улучшить тестируемость компонентов

### Фаза 2: Архитектурные улучшения (2-3 недели)

#### Задача 2.1: Консолидация клиентов Google Sheets
**Описание**: Объединение функциональности синхронного и асинхронного клиентов
**Файлы**: sheets/client.py
**Шаги**:
1. Удалить дублирующий синхронный класс `GoogleSheetsClient`
2. Создать единый асинхронный интерфейс с кэшированием
3. Объединить логику обработки ошибок
4. Убедиться в совместимости с существующим кодом

#### Задача 2.2: Централизация лемматизации
**Описание**: Создание общего модуля для лемматизации
**Файлы**: models/keyword_dictionary.py, utils/category_classifier.py
**Шаги**:
1. Создать отдельный модуль для лемматизации
2. Убрать дублирующую логику из обоих компонентов
3. Обеспечить согласованное поведение в разных компонентах
4. Обновить все вызовы лемматизации

#### Задача 2.3: Улучшение системы миграций
**Описание**: Внедрение более продвинутой системы управления схемой БД
**Файлы**: services/repository.py
**Шаги**:
1. Заменить простую проверку наличия столбцов на полноценную систему миграций
2. Внедрить поддержку отката миграций
3. Обеспечить надежность обновления структуры БД
4. Добавить тестирование миграций

### Фаза 3: Оптимизация (2-3 недели)

#### Задача 3.1: Оптимизация асинхронных операций
**Описание**: Улучшение обработки ошибок 429 с глобальным состоянием
**Файлы**: sheets/client.py
**Шаги**:
1. Реализовать централизованное управление состоянием подключения
2. Улучшить обработку ошибок 429 с учетом глобального состояния
3. Снизить оверхед при работе с Google Sheets API
4. Обеспечить лучшую производительность при высокой нагрузке

#### Задача 3.2: Улучшение разделения ответственности
**Описание**: Перенос бизнес-логики из хендлеров в сервисы
**Файлы**: handlers/*.py
**Шаги**:
1. Вынести бизнес-логику из хендлеров в соответствующие сервисы
2. Снизить связанность компонентов
3. Улучшить тестируемость и поддерживаемость
4. Обеспечить четкое разделение ответственности

## Приоритеты и зависимости

1. **Высокий приоритет** (влияние на стабильность и безопасность):
   - Исправление проблем с целостностью данных → Устранение проблем с асинхронностью → Стандартизация Dependency Injection

2. **Средний приоритет** (архитектурная чистота):
   - Консолидация клиентов Google Sheets → Улучшение системы миграций
   - Централизация лемматизации → Улучшение KeywordDictionary

3. **Низкий приоритет** (производительность и удобство):
   - Оптимизация асинхронных операций → Улучшение разделения ответственности

## Риски и способы их минимизации

1. **Введение регрессий** - минимизация через тестирование
2. **Проблемы с производительностью** - поэтапное внедрение изменений
3. **Проблемы с совместимостью** - сохранение обратной совместимости
4. **Проблемы с Google Sheets API** - тщательное тестирование интеграции

## Критерии успеха

1. **Исправление проблем с целостностью данных** - удалены все `Hotfix` проверки типов
2. **Устранение проблем с асинхронностью** - нет блокировок event loop
3. **Стандартизация Dependency Injection** - унифицированный подход во всех компонентах
4. **Консолидация клиентов Google Sheets** - единый асинхронный интерфейс
5. **Централизация лемматизации** - согласованное поведение в разных компонентах
6. **Улучшение системы миграций** - поддержка отката миграций
7. **Оптимизация асинхронных операций** - улучшенная обработка ошибок 429
8. **Улучшение разделения ответственности** - бизнес-логика вынесена из хендлеров

## Требования к инструментам

Все необходимые инструменты доступны:
- Кодовая база проекта полностью доступна
- Все файлы проекта находятся в рабочей директории
- Система тестирования готова к использованию
- Все зависимости установлены согласно requirements.txt