# Задачи по улучшению проекта Budget Bot

## Таски по безопасности (Критические)

- [x] ### Таск 1: Устранение уязвимости SQL-инъекции
**Название:** Удалить или перепроектировать функцию `query_db` в `db_server.py`
**Описание:** Функция позволяет выполнять произвольные SQL-запросы без параметризации, что создает критическую уязвимость
**Приоритет:** КРИТИЧЕСКИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 2-3 дня
**Definition of Done:**
- Функция `query_db` удалена или безопасно перепроектирована
- Все текущие функции, использующие `query_db`, заменены безопасными аналогами
- Проведено тестирование безопасности
- Обновлена документация

- [x] ### Таск 2: Улучшение аутентификации пользователей
**Название:** Улучшить проверку пользователей в `get_latest_transactions`
**Описание:** Текущая проверка уязвима к атакам через поддельные имена пользователей
**Приоритет:** ВЫСОКИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 1-2 дня
**Definition of Done:**
- Внедрена точная проверка по внутреннему user_id
- Убрана проверка через `str(user_id) in username`
- Проведено тестирование безопасности
- Обновлена документация

## Таски по обработке ошибок

- [ ] ### Таск 3: Улучшение обработки исключений
**Название:** Заменить общие обработчики ошибок на конкретные типы
**Описание:** В нескольких файлах используется общий `except Exception`, что скрывает важные детали ошибок
**Приоритет:** ВЫСОКИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 3-4 дня
**Definition of Done:**
- В `services/transaction_service.py` заменены общие обработчики на конкретные
- В `models/transaction.py` улучшена обработка ошибок парсинга даты
- В `sheets/client.py` улучшена обработка ошибок парсинга даты
- Добавлено логирование стека ошибок
- Проведено тестирование

- [ ] ### Таск 4: Улучшение обработки ошибок API
**Название:** Улучшить обработку ошибок API в `parse_check_from_api`
**Описание:** Недостаточная обработка специфических случаев ошибок API
**Приоритет:** СРЕДНИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 2-3 дня
**Definition of Done:**
- Добавлена обработка специфических ошибок API
- Внедрен механизм повторных попыток с экспоненциальной задержкой
- Добавлено логирование для диагностики
- Проведено тестирование

## Таски по валидации данных

- [ ] ### Таск 5: Валидация пользовательского ввода
**Название:** Добавить строгую валидацию пользовательского ввода
**Описание:** Отсутствие проверки формата ввода в `process_amount_entry` и других местах
**Приоритет:** ВЫСОКИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 2-3 дня
**Definition of Done:**
- Добавлена проверка формата чисел при вводе суммы
- Внедрены ограничения на минимальные и максимальные значения
- Добавлена валидация длины строк и формата ввода
- Проведено тестирование

- [ ] ### Таск 6: Улучшение Pydantic-моделей
**Название:** Добавить строгие ограничения в Pydantic-модели
**Описание:** Отсутствие строгих ограничений в модели `TransactionData`
**Приоритет:** СРЕДНИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 1-2 дня
**Definition of Done:**
- Добавлены ограничения на минимальные/максимальные значения
- Внедрены проверки формата строк
- Добавлены ограничения на длину строковых полей
- Проведено тестирование

- [ ] ### Таск 7: Валидация данных из внешних источников
**Название:** Добавить проверку типа данных из внешних источников
**Описание:** Отсутствие проверки типа данных из Google Sheets
**Приоритет:** СРЕДНИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 2-3 дня
**Definition of Done:**
- Внедрена проверка типов данных при получении из Google Sheets
- Добавлена валидация формата даты/времени
- Добавлена обработка некорректных форматов данных
- Проведено тестирование

## Таски по архитектуре

- [ ] ### Таск 8: Разделение обработчиков
**Название:** Разделить файл `handlers/transactions.py` на несколько модулей
**Описание:** Файл содержит более 1500 строк кода, что нарушает принципы модульности
**Приоритет:** СРЕДНИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 4-5 дней
**Definition of Done:**
- Файл разделен на модули по функциональности (FSM handlers, photo handlers, text handlers)
- Объем кода в одном файле уменьшен до приемлемого уровня
- Улучшена тестируемость отдельных компонентов
- Проведено тестирование

- [ ] ### Таск 9: Внедрение DI и интерфейсов
**Название:** Внедрить внедрение зависимостей и интерфейсы для сервисов
**Описание:** Жесткая связанность между слоями архитектуры
**Приоритет:** ВЫСОКИЙ
**Исполнитель:** Architect
**Оценка трудозатрат:** 5-7 дней
**Definition of Done:**
- Внедрены интерфейсы для всех основных сервисов
- Используется DI для внедрения зависимостей
- Улучшена тестируемость и заменяемость компонентов
- Обновлена архитектурная документация

- [ ] ### Таск 10: Улучшение Local-First архитектуры
**Название:** Реализовать корректный подход Local-First
**Описание:** Нарушение архитектурного принципа Local-First
**Приоритет:** ВЫСОКИЙ
**Исполнитель:** Architect + Coder
**Оценка трудозатрат:** 7-10 дней
**Definition of Done:**
- Обеспечен приоритет локального хранения данных
- Реализован надежный механизм синхронизации
- Гарантировано сохранение транзакций в локальной базе перед отправкой в Google Sheets
- Проведено тестирование

- [ ] ### Таск 11: Устранение глобального состояния
**Название:** Заменить использование глобального объекта `CATEGORY_STORAGE`
**Описание:** Использование глобального состояния нарушает принципы чистой архитектуры
**Приоритет:** СРЕДНИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 3-4 дня
**Definition of Done:**
- Внедрено Dependency Injection для хранения категорий
- Улучшена тестируемость компонентов
- Устранены проблемы с масштабируемостью
- Обновлена документация

## Дополнительные таски

- [x] ### Таск 12: Улучшение обработки callback-данных
**Название:** Улучшить обработку callback-данных с проверкой формата
**Описание:** Использование `split('_')` без проверки количества элементов
**Приоритет:** НИЗКИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 1 день
**Definition of Done:**
- Добавлена проверка количества элементов после split
- Внедрена валидация формата callback-данных
- Добавлена обработка некорректных форматов
- Проведено тестирование

- [ ] ### Таск 13: Улучшение безопасности в системе аутентификации
**Название:** Улучшить систему аутентификации пользователей
**Описание:** `AllowedUsersFilter` позволяет всем пользователям доступ при пустом списке
**Приоритет:** СРЕДНИЙ
**Исполнитель:** Coder
**Оценка трудозатрат:** 1-2 дня
**Definition of Done:**
- Улучшена логика проверки списка разрешенных пользователей
- Добавлено явное указание режима работы (публичный/ограниченный)
- Внедрено логирование попыток доступа
- Проведено тестирование