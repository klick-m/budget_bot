# Master Directive: Итерация 3 — Безопасность, Чистка и Аналитика

## 1. Глобальная цель
Трансформировать Budget Bot из персонального инструмента в масштабируемую многопользовательскую систему. Основные приоритеты: внедрение централизованной авторизации через базу данных, полное устранение устаревшего синхронного кода и запуск модуля внутренней аналитики.

---

## 2. System Blueprint (Архитектурный облик)
* **Управление пользователями:** Переход от авторизации через `.env` к хранению профилей в SQLite.
* **Слой безопасности:** Внедрение Middleware (aiogram) как единой точки фильтрации всех входящих обновлений.
* **Инверсия зависимостей (DI):** Рефакторинг `TransactionService` для инкапсуляции классификатора и хранилища категорий, минимизируя зависимости хендлеров от глобальных объектов.
* **Модуль визуализации:** Создание сервиса аналитики для генерации графических отчетов (Pie Charts) на базе данных из БД и Sheets.

---

## 3. Технические спецификации
* **База данных (SQLite):** Добавить таблицу `users` со следующими полями: `id` (PK), `telegram_id` (Unique), `username`, `role` (admin/user), `monthly_limit`.
* **Middleware:** Реализовать `AuthMiddleware`. Логика: извлекать пользователя из БД по `telegram_id`. Если пользователь отсутствует — прерывать обработку (или выдавать предупреждение).
* **Google Sheets:** Полная депрекация и удаление класса `GoogleSheetsClient` в `sheets/client.py`. Использовать исключительно асинхронный `GoogleSheetsCache`.
* **Аналитика:** Использование библиотеки `matplotlib` для отрисовки графиков.

---

## 4. План реализации (Action Plan)

### Этап 1: Безопасность и Авторизация (REF-009)
1.  **FEAT-USER-DB:** Реализовать метод `init_db` для создания таблицы `users` в `services/repository.py`. ✅
2.  **CHORE-MIGRATE:** Создать скрипт для переноса существующих ID из `ALLOWED_USER_IDS` в таблицу `users`. ✅
3.  **REF-AUTH-MW:** Разработать Middleware авторизации. Зарегистрировать её в `main.py`. Удалить устаревший `AllowedUsersFilter` из всех файлов в `handlers/`. ✅

### Этап 2: Устранение технического долга (REF-010)
1.  **REF-SHEETS-CLEAN:** Удалить синхронный клиент в `sheets/client.py`. Обновить методы `get_sheet_data` для работы через асинхронный кэш. ✅
2.  **FIX-ASYNC-DICT:** Исправить `update_from_sheets` в `models/keyword_dictionary.py`, обеспечив контролируемое асинхронное выполнение без блокировок. ✅
3.  **REF-SERVICE-DI:** Перенести инициализацию `classifier` и `CATEGORY_STORAGE` в конструктор `TransactionService`. Обновить инъекцию зависимостей в хендлерах. ✅

### Этап 3: Аналитика и Отчеты (FEAT-011)
1.  **FEAT-ANALYTICS-SRV:** Создать `services/analytics_service.py` для агрегации расходов по категориям за текущий месяц. ❌
2.  **FEAT-REPORT-CMD:** Реализовать команду `/report` в `handlers/common.py`. Результат: отправка сгенерированного изображения графика пользователю. ❌

---

## 5. Инструкции для Архитектора (VSCode)
1.  **Impact Analysis:** Удаление `AllowedUsersFilter` — критическое изменение. Убедись, что Middleware корректно обрабатывает все типы Update (Message, CallbackQuery).
2.  **TDD Protocol:** Каждое изменение в Repository или Middleware должно сопровождаться тестом в папке `tests/`.
3.  **Modularity:** Не объединяй логику аналитики с хендлерами; используй `AnalyticsService` как промежуточный слой.

---

## 6. Definition of Done (DoD)
* [x] Бот успешно проходит `tests/smoke_test.py`.
* [x] Пользователи, не внесенные в таблицу `users`, не могут взаимодействовать с ботом.
* [x] Команда `/test_sheets` отрабатывает корректно через полностью асинхронный клиент.
* [ ] Команда `/report` генерирует и отправляет корректный Pie Chart.
* [x] В папке `handlers/` отсутствуют импорты глобальных объектов категорий и классификатора.