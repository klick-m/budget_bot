# План интеграции AI в Budget Bot

## Обзор текущей системы

Budget Bot - это Telegram-бот для ведения личного бюджета, который позволяет автоматически распознавать чеки и записывать транзакции в Google Таблицы. Бот использует API Proverkacheka.com для анализа чеков и предоставляет удобный интерфейс для управления расходами и доходами.

### Текущие компоненты системы:
- **API распознавания чеков**: Proverkacheka.com API для извлечения информации из чеков по QR-коду
- **Система категоризации**: 
  - Простой механизм на основе ключевых слов ([`utils/receipt_logic.py:13:map_category_by_keywords()`](utils/receipt_logic.py:13))
  - Улучшенная ML-модель с использованием TF-IDF ([`utils/category_classifier.py:15:TransactionCategoryClassifier()`](utils/category_classifier.py:15))
- **Хранение данных**: Google Sheets
- **Интерфейс**: Telegram-бот на основе aiogram

## Текущая архитектура обработки чеков

1. Пользователь отправляет фото QR-кода чека
2. Изображение отправляется в API Proverkacheka.com ([`utils/receipt_logic.py:62:parse_check_from_api()`](utils/receipt_logic.py:62))
3. API возвращает структурированные данные чека ([`models/transaction.py:6:CheckData()`](models/transaction.py:6))
4. Система пытается автоматически определить категорию:
   - Сначала используется простой механизм по ключевым словам ([`utils/receipt_logic.py:13:map_category_by_keywords()`](utils/receipt_logic.py:13))
   - Затем применяется ML-модель для уточнения категории ([`utils/category_classifier.py:105:predict_category()`](utils/category_classifier.py:105))
5. Транзакция записывается в Google Таблицы

## План интеграции AI

### Этап 1: Улучшение текущей ML-модели категоризации

#### 1.1. Оптимизация существующей модели TF-IDF
- **Цель**: Повысить точность текущей модели на основе TF-IDF
- **Реализация**:
  - Добавить больше признаков (N-граммы, POS-теги, эмбеддинги слов)
  - Оптимизировать веса признаков
  - Внедрить кросс-валидацию для оценки качества
  - Добавить механизм онлайн-обучения для адаптации к новым паттернам

#### 1.2. Внедрение более сложных моделей
- **Цель**: Заменить или дополнить TF-IDF более мощными моделями
- **Реализация**:
  - Обучение классификатора на основе BERT-подобных моделей для русского языка (например, RuBERT)
  - Использование LightGBM или XGBoost для гибридной модели
  - Внедрение ансамбля моделей для повышения точности

### Этап 2: Интеграция внешних AI-сервисов

#### 2.1. Использование LLM для анализа чеков
- **Цель**: Использовать большие языковые модели для более точного анализа содержимого чеков
- **Реализация**:
  - Интеграция с OpenAI API, Claude или локальными моделями (например, Llama)
  - Использование LLM для извлечения сущностей из текста чека
  - Анализ контекста покупки для более точного определения категории
  - Возможность генерации описаний транзакций на основе содержимого чека

#### 2.2. Внедрение мультимодальных моделей
- **Цель**: Использовать как текстовую информацию из чека, так и визуальные признаки
- **Реализация**:
  - Интеграция с мультимодальными моделями (например, CLIP, BLIP)
  - Использование изображения чека как дополнительного источника информации
  - Повышение точности распознавания в случаях, когда текстовая информация неполная

### Этап 3: Улучшение анализа и рекомендаций

#### 3.1. Интеллектуальный анализ расходов
- **Цель**: Предоставление пользователю персонализированных рекомендаций и аналитики
- **Реализация**:
  - Внедрение моделей для выявления аномалий в расходах
  - Прогнозирование будущих расходов на основе исторических данных
  - Генерация рекомендаций по оптимизации бюджета
  - Классификация транзакций по временным паттернам (сезонность, недельные циклы)

#### 3.2. Персонализированная система категорий
- **Цель**: Автоматическое создание и адаптация категорий под конкретного пользователя
- **Реализация**:
  - Использование кластеризации для автоматического определения новых категорий
  - Адаптивное обучение под поведение конкретного пользователя
  - Возможность автоматического предложения новых категорий

### Этап 4: Улучшение интеграции с Proverkacheka.com API

#### 4.1. Оптимизация обработки API-ответов
- **Цель**: Повысить эффективность использования API и улучшить качество извлеченных данных
- **Реализация**:
  - Внедрение кэширования результатов API для повторных запросов
  - Добавление обработки частичных ответов от API
  - Использование дополнительных полей из API (например, тип операции, детализация товаров)

#### 4.2. Резервные механизмы распознавания
- **Цель**: Обеспечить надежность системы при проблемах с API
- **Реализация**:
  - Внедрение альтернативных API для распознавания чеков
  - Создание локальной модели распознавания как резервной опции
  - Обработка ошибок и автоматическое переключение между источниками

## Архитектурные изменения

### Модульная структура AI-компонентов
- Создание отдельного модуля `ai_components/` для всех AI-моделей
- Внедрение интерфейсов для различных типов классификаторов
- Создание системы оценки и сравнения моделей
- Внедрение системы A/B тестирования для новых моделей

### Система управления моделями
- Хранение и версионирование моделей
- Автоматическое обновление моделей по расписанию
- Мониторинг производительности моделей
- Система отката к предыдущим версиям при ухудшении качества

## План реализации

### Фаза 1 (0-2 месяца): Подготовка инфраструктуры
- [ ] Создание модульной структуры для AI-компонентов
- [ ] Настройка системы версионирования моделей
- [ ] Внедрение метрик оценки качества классификации
- [ ] Создание датасета для обучения и тестирования моделей

### Фаза 2 (2-4 месяца): Улучшение текущей модели
- [ ] Оптимизация существующей TF-IDF модели
- [ ] Внедрение новых признаков и гибридных моделей
- [ ] Тестирование и оценка улучшенной модели
- [ ] Пилотный запуск для ограниченного числа пользователей

### Фаза 3 (4-6 месяцев): Интеграция внешних AI-сервисов
- [ ] Интеграция с LLM для анализа чеков
- [ ] Внедрение мультимодальных моделей
- [ ] Создание системы рекомендаций
- [ ] Тестирование с реальными пользователями

### Фаза 4 (6-8 месяцев): Расширение функциональности
- [ ] Внедрение персонализированной системы категорий
- [ ] Создание системы анализа и прогнозирования расходов
- [ ] Оптимизация интеграции с Proverkacheka.com API
- [ ] Полноценный запуск всех AI-функций

## Оценка ресурсов

### Вычислительные ресурсы
- GPU для обучения моделей (время от времени)
- Серверы для инференса (если используются локальные модели)
- API-ключи для внешних AI-сервисов (OpenAI, Claude и др.)

### Данные
- Аннотированный датасет транзакций для обучения
- Исторические данные пользователей (с согласия)
- Тестовые данные для оценки качества

## Оценка эффективности

### Метрики качества
- Точность (Accuracy) классификации категорий
- F1-мера для каждой категории
- Уровень уверенности модели
- Время отклика системы

### Бизнес-метрики
- Уровень автоматизации категоризации (без участия пользователя)
- Удовлетворенность пользователей точностью категоризации
- Увеличение вовлеченности пользователей
- Снижение количества исправлений, вносимых вручную

## Риски и меры по их снижению

1. **Зависимость от внешних API**: Внедрение резервных механизмов и кэширования
2. **Конфиденциальность данных**: Обработка данных на стороне клиента или шифрование
3. **Стоимость использования AI-сервисов**: Оптимизация запросов и использование локальных моделей
4. **Ухудшение производительности**: Постепенное внедрение и A/B тестирование