# Отчет: Улучшения системы категоризации транзакций в Budget Bot без использования AI

## Обзор

В рамках анализа текущей системы категоризации транзакций в Budget Bot были предложены и внедрены комплексные улучшения без использования AI компонентов. Ниже представлены все разработанные решения по улучшению извлечения ключевых слов, их нормализации, созданию словаря ключевых слов и улучшению алгоритмов категоризации.

## 1. Улучшение извлечения ключевых слов

### 1.1. Расширение извлекаемых признаков
- Добавить извлечение триграмм (после биграмм) в `utils/category_classifier.py:27:extract_features()`
- Внедрить нормализацию слов (стемминг/лемматизация) с использованием `pymorphy2` для русского языка
- Извлекать числовые признаки (цены, количества) как отдельные категории признаков

### 1.2. Улучшение фильтрации признаков
- Внедрить стоп-слова для русского языка и удалять их из текста
- Использовать более продвинутую фильтрацию на основе частотности
- Добавить фильтрацию по POS-тегам (существительные, глаголы, прилагательные)

## 2. Методы нормализации ключевых слов

### 2.1. Лемматизация

## 3. Новая система распознавания категорий по ключевым словам

### 3.1. Внедрение KeywordDictionary
- Создан новый класс `KeywordDictionary` в `models/keyword_dictionary.py` с поддержкой:
  - Хранения ключевых слов по категориям с уровнями уверенности
  - Обратного индекса для быстрого поиска
  - Статистики использования
  - Поддержки биграмм и униграмм
  - Интеграции с Google Sheets

### 3.2. Интеграция с существующей системой
- Обновлен `TransactionCategoryClassifier` в `utils/category_classifier.py` для использования `KeywordDictionary`
- Модифицирована функция `map_category_by_keywords` в `utils/receipt_logic.py` для приоритетного использования новой системы
- Обновлен `sheets/client.py` для синхронизации данных с Google Sheets
- Добавлена настройка `KEYWORDS_SPREADSHEET_ID` и `KEYWORDS_SHEET_NAME` в `config.py`

### 3.3. Улучшенная обработка чеков
- В `handlers/transactions.py` добавлена логика использования новой системы при обработке чеков
- Приоритет отдается результатам от `KeywordDictionary` при высокой уверенности (>0.7)
- Резервное использование ML-классификатора при низкой уверенности
Использование библиотеки `pymorphy3` для приведения слов к начальной форме:
```python
from pymorphy3 import MorphAnalyzer
morph = MorphAnalyzer()
lemma = morph.parse(word)[0].normal_form
```

### 2.2. Контекстная нормализация
- Создание словарей синонимов для категорий
- Нормализация брендов и торговых марок
- Удаление юридических форм (ОО, ИП, ОАО и т.д.)

## 3. Система словаря ключевых слов

### 3.1. Структура хранения
Создать класс `KeywordDictionary` с:
- Хранением ключевых слов по категориям с весами
- Обратным индексом для быстрого поиска
- Статистикой использования и датами обновления
- Поддержкой биграмм (сочетаний слов)

Вместо того чтобы хранить все ключевые слова для категории "Продукты" в одной ячейке Google Sheets, мы создаем отдельный лист с тремя основными столбцами:

| Столбец (Google Sheets) | Назначение |
|-------------------------|------------|
| КЛЮЧЕВОЕ_СЛОВО | Фактическое слово или фраза (например, "Ашан", "Перекресток", "молоко"). |
| КАТЕГОРИЯ | Категория, к которой это слово относится (например, "Продукты", "Транспорт"). |
| УВЕРЕННОСТЬ / ПРИОРИТЕТ | Числовое значение, показывающее, насколько надежно это слово определяет категорию (например, 1.0 для "Uber", 0.6 для "Кафе"). |

Преимущества такого подхода:
- **Масштабируемость**: Можно добавить сотни ключевых слов, и таблица будет расти вертикально, не "краша" ячейку.
- **Управляемость**: Гораздо проще редактировать, удалять или добавлять новые ключевые слова.
- **Готовность к ML**: Эта таблица фактически становится ручным датасетом и словарем признаков (Feature Dictionary) для обучения и оптимизации существующих моделей TF-IDF.

### 3.2. Методы обновления
- Добавление/удаление ключевых слов
- Обновление статистики использования
- Извлечение ключевых слов из транзакций
- Нормализация текста для сопоставления

### 3.3. Интеграция с существующей системой
- Создание интегрированного классификатора, который комбинирует словарь и ML-модель
- Двунаправленная синхронизация с Google Sheets
- Обработка ошибок и таймаутов
- Кеширование для производительности

## 4. Улучшение алгоритмов категоризации

### 4.1. Оптимизация TF-IDF модели
- Добавление N-грамм (триграммы и выше)
- Улучшение препроцессинга с лемматизацией
- Использование BM25 вместо простого TF-IDF

### 4.2. Гибридные подходы
Создание системы, которая использует несколько подходов:
- Проверка точных совпадений ключевых слов
- Использование TF-IDF для менее очевидных случаев
- Применение бизнес-правил
- Контекстно-зависимая категоризация

### 4.3. Онлайн-обучение
- Обновление модели на основе обратной связи пользователя
- Учет уверенности предсказания для принятия решения об обновлении модели
- Введение порогов уверенности для автоматического подтверждения категорий

### 4.4. Улучшение метрик уверенности
- Введение более точных метрик уверенности
- Комбинирование факторов: нормализованная уверенность, соотношение совпадений признаков, разница между лучшей и второй лучшей категорией
- Система порогов для принятия решений

### 4.5. Архитектура ансамбля моделей
- Создание системы, объединяющей несколько моделей (TF-IDF, правило-базовая, ключевое слово-базовая)
- Взвешенное голосование для получения итогового результата

## Заключение

Все эти улучшения могут быть реализованы с использованием традиционных методов программирования и не требуют внешних AI-сервисов, что делает систему более надежной и экономически эффективной. Реализация этих улучшений позволит значительно повысить точность и надежность системы категоризации транзакций в Budget Bot.