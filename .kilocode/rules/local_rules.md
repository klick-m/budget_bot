# Workflow Rules: Efficiency & Context Management

## 1. Tool Usage Strategy (Search-First)
- **Codebase Index Priority**: Любое исследование кодовой базы ДОЛЖНО начинаться с использования инструментов поиска по индексу `codebase_search`. 
- **Read File as Last Resort**: Инструмент `read_file` (чтение файла целиком) разрешен только после того, как поиск сузил область исследования до конкретного файла.
- **Fragment Reading**: Если размер файла превышает 100 строк, агент обязан использовать чтение фрагментов (по строкам или символам), если задача касается конкретного метода или класса.
- **Cost Justification**: Перед вызовом `read_file` для большого файла, агент должен зафиксировать в блоке `thought`, почему поиск по индексу не дал достаточной информации.

## 2. Memory Bank Usage
- **Context Anchor**: Агент обязан обращаться к `memory-bank/architecture.md` и `memory-bank/tech.md` для понимания глобальной структуры проекта. Запрещено восстанавливать архитектурную картину путем чтения всех файлов в папках `services/` или `handlers/`.
- **Decision Tracking**: Все архитектурные решения (ADR) проверяются по `architecture.md`, а не по "стилю" случайно прочитанных файлов.

## 3. Code Modification Rules
- **No Overwriting**: Запрещено переписывать файлы целиком для внесения мелких правок. Используй точечные изменения.
- **Dependency Awareness**: Перед изменением сигнатуры метода в `services/`, агент обязан выполнить поиск по всей кодовой базе, чтобы найти и обновить все места вызова этого метода.
- **Service-Repository Boundary**: Любая попытка добавить SQL-запрос в файл, отличный от `repository.py`, должна блокироваться с предупреждением о нарушении Repository Pattern.

## 4. Quality Control
- **Test folder location**: Файлы тестов которые создаются в процессе работы должны сохраняться в папке `tests/`. Запрещено сохранять файлы тестов в корневую папку проекта.

- **Self-Verification**: После изменения кода агент обязан просканировать соответствующие тесты в папке `tests/` и запустить их из виртуального окружения `.venv`, или предложить план тестирования.
- **No Hallucinations**: Если поиск по индексу не дает результатов, агент должен сообщить об отсутствии информации, а не галлюцинировать структуру файлов.

## 5. Task Finalization & Memory Bank Sync (Mandatory)
- **No Update, No Done**: После выполнения всех задач из текущего ToDo списка обязательно обнови соответствующие файлы в `Docs\memory-bank`! Файлы должны быть приведены в соответствие с изменениями в коде. Это не является не обязательным условием!
Необходимо:
    1. Обновить `current_task.md`: отметить шаги как выполненные и очистить поле для следующей итерации.
    2. Обновить `context.md`: если изменилось состояние проекта или появились новые зависимости.
    3. Обновить `architecture.md` и\или `tech.md`: если были добавлены новые компоненты, сервисы или изменены паттерны.
- **Verification Step**: В финальном ответе пользователю о завершении задачи ты должен поддтверджить и кратко перечислить, какие файлы Memory Bank были обновлены.