# Улучшение обработки исключений

## Проблема

В текущей реализации используются общие обработчики `except Exception` или `except` без указания типа, что скрывает важные детали ошибок и затрудняет диагностику проблем.

## Техническая спецификация для разработчика

### 1. Улучшение обработки исключений в `services/transaction_service.py`

#### 1.1. Метод `save_transaction` (строка 107)
**Текущий код:**
```python
except Exception as e:
    raise SheetWriteError(f"Ошибка при записи транзакции в SQLite: {e}")
```

**Требуемый код:**
```python
except Exception as e:
    import traceback
    logger.error(f"Ошибка при записи транзакции в SQLite: {e}")
    logger.debug(f"Стек вызова: {traceback.format_exc()}")
    raise SheetWriteError(f"Ошибка при записи транзакции в SQLite: {e}")
```

**Дополнительно:** Убедиться, что в начале файла импортирован модуль `logger` из `config`.

#### 1.2. Метод `finalize_transaction` (строка 155)
**Текущий код:**
```python
except Exception as e:
    return {
        'success': False,
        'error': f"Неизвестная ошибка: {e}"
    }
```

**Требуемый код:**
```python
except Exception as e:
    import traceback
    logger.error(f"Неизвестная ошибка при финализации транзакции: {e}")
    logger.debug(f"Стек вызова: {traceback.format_exc()}")
    return {
        'success': False,
        'error': f"Неизвестная ошибка: {e}"
    }
```

### 2. Улучшение обработки ошибок парсинга даты в `models/transaction.py`

#### 2.1. Свойство `transaction_datetime` (строка 30)
**Текущий код:**
```python
except Exception:
    pass # Если парсинг не удался, переходим к current_datetime
```

**Требуемый код:**
```python
except ValueError as e:
    import traceback
    from config import logger
    logger.warning(f"Ошибка парсинга даты транзакции '{self.check_datetime_str}': {e}")
    logger.debug(f"Стек вызова: {traceback.format_exc()}")
```

**Дополнительно:** Убедиться, что в начале файла импортирован модуль `logger` из `config`.

### 3. Улучшение обработки ошибок парсинга даты в `sheets/client.py`

#### 3.1. Функция `parse_datetime` (строка 511)
**Текущий код:**
```python
except:
    # Если формат даты не распознан, возвращаем минимальную дату
    return datetime.min
```

**Требуемый код:**
```python
except ValueError as e:
    # Если формат даты не распознан, возвращаем минимальную дату
    logger.warning(f"Ошибка парсинга даты и времени: {e}")
    return datetime.min
```

**Дополнительно:** Убедиться, что в начале функции доступен модуль `logger`.

## Требования к логированию

Для всех изменений необходимо:
1. Использовать уровень `logger.error` для критических ошибок
2. Использовать уровень `logger.warning` для предупреждений
3. Использовать уровень `logger.debug` для стека вызовов
4. Всегда логировать стек вызовов с помощью `traceback.format_exc()` на уровне debug
5. Включать в сообщение об ошибке контекстную информацию (например, значение даты, которое не удалось распарсить)

## Тестирование

После реализации изменений необходимо:
1. Проверить, что все исключения корректно обрабатываются
2. Проверить, что в логах появляется информация о стеке вызовов
3. Проверить, что при ошибках система продолжает работоспособность
4. Убедиться, что не сломана существующая функциональность