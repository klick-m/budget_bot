# Tech: Budget Bot

## Технологический стек

### Язык программирования
- **Python 3.11+**: Основной язык для приложения с поддержкой async/await для высокой производительности

### Фреймворки и библиотеки
- **aiogram 3.x**: Асинхронный фреймворк для Telegram-ботов для обработки пользовательских взаимодействий
- **Pydantic v2**: Валидация данных и управление настройками для моделей транзакций
- **aiohttp**: Асинхронный HTTP-клиент для API-коммуникаций (распознавание чеков, внешние сервисы)

### Технологии баз данных
- **SQLite**: Локальное хранилище с использованием aiosqlite для асинхронных операций в архитектуре Local-First
- **Google Sheets API**: Облачное хранилище и аналитика с использованием gspread и gspread-asyncio

### Обработка естественного языка
- **pymorphy3**: Лемматизация русского текста для улучшения распознавания категорий и сопоставления ключевых слов

### Разработка и тестирование
- **python-dotenv**: Управление переменными окружения для конфигурации
- **pytest + pytest-asyncio**: Тестовый фреймворк для синхронного и асинхронного кода

### Архитектура и утилиты
- **asyncio**: Встроенная библиотека Python для асинхронного программирования и управления циклом событий
- **dataclasses**: Для структурированного представления данных в моделях транзакций
- **typing**: Для аннотаций типов и лучшей поддержки кода

## Настройка разработки

### Структура проекта
Проект следует модульной архитектуре с четким разделением ответственности:
- `main.py` - Точка входа в приложение и инициализация бота
- `config.py` - Конфигурация и управление окружением
- `handlers/` - Обработчики Telegram-сообщений и обратных вызовов
- `models/` - Модели Pydantic
- `services/` - Бизнес-логика и обработка транзакций
- `sheets/` - Интеграция с Google Таблицами
- `utils/` - Вспомогательные функции и утилиты

### Управление конфигурацией
- Переменные окружения загружаются через python-dotenv
- Централизованная конфигурация в `config.py` с настройкой логирования
- Хранение категорий и управление ключевыми словами через класс `CategoryStorage`

### Паттерны асинхронной архитектуры
- Полная асинхронная реализация с использованием asyncio и async/await
- Асинхронные контекстные менеджеры для подключений к базе данных
- Фоновый рабочий процесс синхронизации для Google Таблиц
- Асинхронные обработчики для неблокирующего взаимодействия с пользователем

### Обработка ошибок и ведение логов
- Пользовательские исключения для различных типов ошибок (SheetConnectionError, SheetWriteError и т.д.)
- Комплексное ведение логов со структурированными сообщениями
- Ограничение частоты запросов и логика повторных попыток для внешних API-вызовов
- Плавное ухудшение функциональности при недоступности внешних сервисов

## Развертывание и выполнение

### Зависимости
Все зависимости управляются через `requirements.txt` с диапазонами версий для совместимости.

### Переменные окружения
- `BOT_TOKEN`: Токен API Telegram-бота
- `GOOGLE_SHEET_URL`: URL-адрес Google Таблицы для хранения транзакций
- `SERVICE_ACCOUNT_FILE`: Путь к JSON-файлу учетной записи службы Google
- `CHECK_API_TOKEN`: Токен API для сервиса распознавания чеков
- `ALLOWED_USER_IDS`: Необязательный список разрешенных ID пользователей для контроля доступа

### Скрипты выполнения
- `run_bot.bat`: Пакетный скрипт Windows для запуска бота
- Основное приложение использует цикл событий asyncio для асинхронного выполнения