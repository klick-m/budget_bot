# Задача: Исправление логики ручного ввода транзакций

## Название задачи
Исправить поведение бота при ручном вводе транзакций

## Описание задачи
При ручном вводе транзакции бот работает неправильно. Нарушена логика работы:
1. При вводе "сосиски 300" бот может предложить категорию "другое", комментарий "сосиски", сумму "300"
2. При нажатии кнопки "изменить категорию" и выборе пользовательской категории, бот сразу же без подтверждения записывает транзакцию с пользовательской категорией, но без комментария (значение "сосиски" теряется)
3. При вводе следующей транзакции автоматически предлагается последняя использованная категория, распознавание категорий по ключевым словам не работает

## Проблемы
1. Некорректная обработка пользовательского ввода при ручном вводе транзакций
2. Отсутствие подтверждения при изменении категории
3. Потеря комментария при изменении категории
4. Нарушенная логика выбора категории по умолчанию (всегда последняя использованная)
5. Не работает распознавание категорий по ключевым словам

## План реализации

### [Backend] Исправление логики обработки ручного ввода
- [x] Найти и изучить текущую реализацию FSM для ручного ввода транзакций
- [x] Исправить логику обработки пользовательского ввода чтобы правильно определять категорию
- [x] Обеспечить сохранение комментария при изменении категории
- [x] Добавить подтверждение при изменении категории перед записью транзакции
- [x] Исправить логику выбора категории по умолчанию, чтобы не использовалась последняя категория
- [x] Восстановить функциональность распознавания категорий по ключевым словам

### [Backend] Обновление системы категоризации
- [x] Проверить работу ML-классификатора при ручном вводе
- [x] Убедиться, что лемматизация работает корректно для ручного ввода
- [x] Обеспечить правильное сопоставление ключевых слов с категориями
- [x] Обновить логику обновления словаря ключевых слов при изменении категории пользователем

### [Tests] Проверка и тестирование изменений
- [ ] Создать тесты для проверки корректного парсинга ручного ввода
- [ ] Протестировать сценарий изменения категории с сохранением комментария
- [ ] Проверить, что транзакция не записывается без подтверждения при изменении категории
- [ ] Протестировать правильную работу распознавания категорий по ключевым словам
- [ ] Убедиться, что при вводе новой транзакции не используется последняя категория по умолчанию
- [ ] Проверить, что не сломана существующая функциональность

## Требования к реализации
- При ручном вводе "сосиски 300" должна правильно определяться категория на основе ключевых слов
- При изменении категории должна появляться кнопка подтверждения, а не автоматическая запись
- Комментарий должен сохраняться при изменении категории
- При вводе новой транзакции не должна использоваться последняя категория по умолчанию
- Распознавание категорий по ключевым словам должно работать корректно
- Существующая функциональность не должна быть нарушена

## Ожидаемый результат
- При ручном вводе "сосиски 300" правильно определяется категория на основе ключевых слов
- При изменении категории появляется возможность подтверждения перед записью
- Комментарий сохраняется при изменении категории
- При вводе новой транзакции используется корректная логика выбора категории
- Распознавание категорий по ключевым словам работает как ожидалось
- Существующая функциональность сохранена