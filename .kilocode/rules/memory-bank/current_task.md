# Задача: Улучшение хранения и отображения имени пользователя в Google Таблицах

## Описание задачи
В настоящее время в Google Таблицах отображается формат "user_1", "user_2" и т.д. вместо реальных имен пользователей Telegram. Необходимо изменить формат username в системе, чтобы в таблицу записывались реальные имена пользователей.

## Проблемы
1. В `services/sync_worker.py` строка 26: `username=f"user_{transaction['user_id']}"` - генерирует формат "user_X" вместо реального имени
2. В `services/transaction_service.py` строка 99: `user_id = 1 # В реальной реализации это должно быть получено из контекста` - не используется реальный user_id
3. В `sheets/client.py` строка 490: используется проверка `username == user_id` для безопасности, но формат хранения не соответствует реальным именам

## План реализации

### 1. Backend: Обновление формата хранения в локальной базе данных
- [ ] Модифицировать `services/repository.py` для хранения реального username или full_name пользователя в таблице транзакций
- [ ] Обновить структуру таблицы `transactions` в SQLite для хранения имени пользователя
- [ ] Обеспечить совместимость с существующими данными

### 2. Backend: Обновление логики сохранения транзакций
- [ ] Модифицировать `services/transaction_service.py` для передачи реального username при сохранении транзакции
- [ ] Обновить метод `save_transaction` для использования реального имени пользователя из контекста
- [ ] Обеспечить получение реального username из aiogram-контекста в обработчиках

### 3. Backend: Обновление логики синхронизации
- [ ] Модифицировать `services/sync_worker.py` для использования реального имени пользователя из локальной базы
- [ ] Изменить формат username в строке 26 с `f"user_{transaction['user_id']}"` на реальное имя пользователя
- [ ] Обеспечить корректную передачу username из локальной базы в Google Таблицы

### 4. Backend: Обновление безопасности
- [ ] Обновить логику безопасности в `sheets/client.py` строка 490, чтобы корректно работала проверка `username == user_id` с новым форматом
- [ ] Обеспечить совместимость с системой безопасности, реализованной в `get_latest_transactions`
- [ ] При необходимости обновить логику проверки принадлежности транзакций пользователю

### 5. Tests: Проверка и тестирование изменений
- [ ] Проверить, что транзакции сохраняются с реальными именами пользователей
- [ ] Проверить, что синхронизация с Google Таблицами работает корректно
- [ ] Проверить, что система безопасности продолжает работать
- [ ] Убедиться, что не сломана существующая функциональность
- [ ] Провести тестирование сценариев с разными типами имен пользователей

## Требования к реализации
- Сохранить совместимость с существующей системой безопасности
- Обеспечить корректную работу с именами пользователей в формате username и full_name
- Поддерживать обратную совместимость с уже существующими транзакциями
- Обеспечить корректную обработку случаев, когда username отсутствует

## Ожидаемый результат
- В Google Таблицах отображаются реальные имена пользователей вместо формата "user_X"
- Система безопасности продолжает корректно работать
- Все существующие функции продолжают работать без изменений
- Новые транзакции сохраняются с реальными именами пользователей