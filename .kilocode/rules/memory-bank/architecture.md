# Архитектура: Budget Bot

## Обзор системы

Budget Bot - это Telegram-бот для автоматизированного ведения личного бюджета, реализующий архитектуру Local-First с надежной синхронизацией с Google Таблицами. Система использует машинное обучение для категоризации транзакций и поддерживает как автоматическое распознавание чеков, так и ввод транзакций с помощью обработки естественного языка.

## Основные компоненты

### Структура основного приложения
- **main.py**: Точка входа, которая инициализирует бота, регистрирует обработчики и запускает цикл опроса
- **config.py**: Управление конфигурацией, включая токены API, настройки Google Таблиц и хранение категорий
- **handlers/transactions.py**: Обработка транзакций на основе FSM с поддержкой ручного ввода, обработки чеков и управления историей

### Модели данных
- **models/transaction.py**: Модели Pydantic для транзакций и данных чека с валидацией
- **models/keyword_dictionary.py**: Расширенная система словаря ключевых слов с коэффициентами достоверности, поддержкой биграмм и лемматизацией

### Слой сервисов
- **services/transaction_service.py**: Основной сервис обработки транзакций, который обрабатывает данные чека, применяет ML-классификацию и сохраняет транзакции
- **services/repository.py**: Репозиторий SQLite для локального хранения с асинхронными операциями
- **services/input_parser.py**: Интеллектуальный парсер ввода для транзакций с естественным языком

### Машинное обучение и NLP
- **utils/category_classifier.py**: Классификатор машинного обучения, использующий TF-IDF и частотный анализ с лемматизацией pymorphy3
- **utils/receipt_logic.py**: Логика обработки чеков, включая интеграцию с API Proverkacheka.com

### Интеграция с Google Таблицами
- **sheets/client.py**: Асинхронный клиент Google Таблиц с кэшированием, ограничением частоты запросов и обработкой ошибок

### Утилиты
- **utils/keyboards.py**: Утилиты генерации клавиатур как для обычных, так и для встроенных клавиатур
- **utils/exceptions.py**: Определения пользовательских исключений для различных сценариев ошибок

## Паттерны архитектуры

### Паттерн Repository
Система использует паттерн repository для абстрагирования доступа к данным, где TransactionRepository обрабатывает операции SQLite, а sheets.client обрабатывает операции с Google Таблицами.

### Слой сервисов
TransactionService предоставляет унифицированный интерфейс для обработки транзакций, объединяя валидацию, ML-классификацию и операции хранения.

### Внедрение зависимостей (DI)
Система должна использовать внедрение зависимостей для уменьшения связанности между компонентами и улучшения тестируемости (требует рефакторинга).

### FSM (Конечный автомат)
Бот использует FSM aiogram для управления сложными взаимодействиями с пользователем во время ввода транзакций, состояниями для выбора типа, категории, суммы и комментария.

### Архитектура Local-First
Транзакции сначала записываются в локальную базу данных SQLite, а затем синхронизируются с Google Таблицами фоновым рабочим процессом, что обеспечивает доступность данных даже без подключения к сети.

### Обработка на основе событий
Система использует подход, основанный на событиях, с асинхронными обработчиками для обработки различных типов пользовательского ввода (текст, фото, коллбэки).

## Ключевые технические решения

1. **Дизайн Local-First**: Основное хранилище в SQLite с фоновой синхронизацией с Google Таблицами обеспечивает надежность и возможность работы в автономном режиме
2. **Классификация на основе ML**: TF-IDF с частотным анализом и лемматизацией pymorphy3 для точной категоризации транзакций
3. **Асинхронная архитектура**: Полная асинхронная реализация с использованием asyncio для оптимальной производительности и масштабируемости
4. **Стратегия кэширования**: Данные Google Таблиц кэшируются с TTL для минимизации вызовов API и улучшения времени отклика
5. **Ограничение частоты запросов**: Встроенное ограничение частоты и логика повторных попыток для API Google Таблиц для корректной обработки квот
6. **Восстановление после ошибок**: Комплексная обработка ошибок с резервными вариантами и плавным ухудшением функциональности
7. **Реализация безопасности**: Контроль доступа через фильтр ALLOWED_USER_IDS ограничивает доступ к боту только авторизованным пользователям; устранена критическая уязвимость SQL-инъекции через удаление экспериментального файла db_server.py; устранена уязвимость при проверке пользователей в get_latest_transactions (ранее использовалась проверка `str(user_id) in username`, что позволяло получить доступ к чужим транзакциям)
8. **Архитектурные улучшения**: Планируется внедрение DI, улучшение Local-First подхода, устранение глобального состояния и улучшение валидации данных (в рамках технического долга)
9. **Оптимизация SQLite**: Использование WAL (Write-Ahead Logging) режима для улучшения производительности и уменьшения блокировок при конкурентном доступе
10. **Управление UI-состоянием**: Механизмы очистки предыдущих клавиатур и сообщений для предотвращения накопления интерфейсных элементов в чате
11. **Улучшенная обработка исключений**: Замена общих обработчиков `except Exception` на конкретные типы исключений с детальным логированием стека ошибок для улучшения диагностики и отладки


## Пути исходного кода

- **Основное приложение**: `main.py`
- **Конфигурация**: `config.py`
- **Обработчики**: `handlers/transactions.py`
- **Модели**: `models/transaction.py`, `models/keyword_dictionary.py`
- **Сервисы**: `services/transaction_service.py`, `services/repository.py`, `services/input_parser.py`, `services/global_service_locator.py`
- **ML/NLP**: `utils/category_classifier.py`, `utils/receipt_logic.py`
- **Интеграция с Таблицами**: `sheets/client.py`
- **Утилиты**: `utils/keyboards.py`, `utils/exceptions.py`

## Отношения компонентов

```
main.py -> handlers/transactions.py -> services/transaction_service.py -> services/repository.py
                                     -> services/transaction_service.py -> sheets/client.py
                                     -> utils/category_classifier.py
                                     -> utils/receipt_logic.py
                                     -> models/transaction.py
                                     -> models/keyword_dictionary.py
```

Система спроектирована как модульная с четким разделением ответственности, что позволяет легко поддерживать и расширять функциональность.