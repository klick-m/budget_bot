# Budget Bot

Budget Bot - это Telegram-бот для автоматизированного ведения личного бюджета, который позволяет автоматически распознавать чеки и записывать транзакции в Google Таблицы. Бот использует API Proverkacheka.com для анализа чеков и предоставляет удобный интерфейс для управления расходами и доходами. Система реализована по Local-First архитектуре с локальным хранением в SQLite и фоновой синхронизацией с Google Sheets, включает умную категоризацию с использованием машинного обучения и лемматизации, а также поддерживает FSM для сложных сценариев ввода транзакций и умный ввод через естественный язык.

## Структура проекта

```
budget_bot/
├── .gitignore                 # Файл игнорирования для Git
├── config.py                  # Конфигурация приложения (токены, настройки)
├── db_server.py               # Сервер для работы с базой данных
├── main.py                    # Основной файл запуска бота
├── README.md                  # Документация проекта
├── requirements.txt           # Зависимости проекта
├── run_bot.bat                # Скрипт для запуска бота
├── test_lemmatization.py      # Тесты для лемматизации
├── test_smart_parser.py       # Тесты для умного парсера
├── test_taxi_classification.py # Тесты для классификации такси
├── .kilocode/                 # Конфигурация KiloCode
├── handlers/                  # Обработчики команд и событий
│   └── transactions.py        # FSM-обработчики транзакций с черновиками и умным вводом
├── models/                    # Модели данных
│   ├── keyword_dictionary.py  # Модель словаря ключевых слов с лемматизацией
│   └── transaction.py         # Модели транзакций и чеков
├── scripts/                   # Скрипты для различных задач
│   └── smoke_test.py          # Скрипт для проверки работоспособности
├── services/                  # Бизнес-логика и сервисы
│   ├── __init__.py
│   ├── global_service_locator.py # Локатор глобальных сервисов
│   ├── input_parser.py        # Парсер умного ввода транзакций
│   ├── repository.py          # Репозиторий для работы с SQLite
│   ├── sync_worker.py         # Фоновый воркер для синхронизации с Google Sheets
│   ├── text_parser.py         # Парсер текста транзакций
│   └── transaction_service.py # Сервис обработки транзакций
├── sheets/                    # Работа с Google Sheets
│   └── client.py              # Асинхронный клиент для работы с Google Sheets
├── tests/                     # Тесты
│   ├── conftest.py
│   ├── generate_new_role.py
│   ├── test_category_classifier.py # Тесты классификатора категорий
│   ├── test_keyword_dictionary.py # Тесты словаря ключевых слов
│   ├── test_morph_analyzer_initialization.py # Тесты инициализации морф. анализатора
│   └── test_sqlite_integration.py # Тесты интеграции с SQLite
└── utils/                     # Вспомогательные утилиты
    ├── category_classifier.py # Классификатор категорий с машинным обучением и лемматизацией
    ├── exceptions.py          # Кастомные исключения
    ├── keyboards.py           # Клавиатуры бота
    ├── keyword_classifier.py  # Классификатор ключевых слов
    ├── receipt_logic.py       # Логика обработки чеков
    └── service_wrappers.py    # Обертки для сервисов
```

## Существующие модели данных

### Модель транзакции (TransactionData)

| Поле | Описание |
|------|----------|
| type | Тип транзакции (Расход/Доход) |
| category | Категория транзакции |
| amount | Сумма транзакции |
| comment | Комментарий к транзакции |
| username | Имя пользователя Telegram |
| retailer_name | Название магазина/продавца |
| items_list | Список позиций из чека |
| payment_info | Способ оплаты (Наличные/Карта/Электронный платеж) |
| transaction_dt | Дата и время транзакции (datetime) |

### Модель чека (CheckData)

| Поле | Описание |
|------|----------|
| type | Тип транзакции (по умолчанию "Расход") |
| category | Категория транзакции |
| amount | Сумма транзакции |
| comment | Комментарий к транзакции |
| retailer_name | Название магазина/продавца |
| items_list | Список позиций из чека |
| payment_info | Способ оплаты |
| check_datetime_str | Сырая строка даты из API чека |

### Локальная SQLite таблица "transactions" (для Local-First архитектуры)

| Поле | Описание |
|------|----------|
| id | Уникальный идентификатор транзакции |
| user_id | Идентификатор пользователя |
| amount | Сумма транзакции |
| category | Категория транзакции |
| comment | Комментарий к транзакции |
| created_at | Дата и время создания записи |
| is_synced | Флаг синхронизации с Google Sheets (0 - не синхронизировано, 1 - синхронизировано) |

### Таблица "RawData" в Google Sheets (основная таблица транзакций)

| Поле | Описание |
|------|----------|
| Дата операции | Дата транзакции в формате ДД.ММ.ГГГГ |
| Время операции | Время транзакции в формате ЧЧ:ММ:СС |
| Тип | Тип транзакции (Расход/Доход) |
| Категория | Категория транзакции |
| Сумма | Сумма транзакции |
| Комментарий | Комментарий к транзакции |
| Username | Имя пользователя Telegram |
| Продавец | Название магазина/продавца |
| Позиции | Список позиций из чека |
| Оплата | Способ оплаты (Наличные/Карта/Электронный платеж) |

### Таблица "Categories" в Google Sheets (таблица категорий)

| Поле | Описание |
|------|----------|
| Ключевое слово | Ключевое слово для определения категории |
| Категория | Название категории |
| Уверенность | Коэффициент уверенности (0.0-1.0) для ключевого слова |

## Реализованные команды

| Команда | Описание |
|---------|----------|
| `/start` | Приветственное сообщение и основное меню |
| `/new_transaction` | Начать добавление новой транзакции вручную с помощью FSM |
| `/test_sheets` | Проверка подключения к Google Таблицам |
| `/history` | Просмотр истории транзакций с пагинацией |

## Ключевые фичи

1. **Автоматическое распознавание чеков**: Бот может распознавать чеки по фото QR-кода и автоматически извлекать информацию о покупке (сумму, дату, продавца, список товаров).

2. **Умная категоризация**: Используется машинное обучение и лемматизация (pymorphy3) для автоматического определения категории транзакции на основе ключевых слов, истории покупок и контекста.

3. **Ручной выбор категории**: При низкой уверенности в автоматическом определении категории, пользователю предлагается выбрать подходящую категорию из списка.

4. **Редактирование категории**: Возможность изменить автоматически определенную категорию перед сохранением транзакции.

5. **Запись в Google Таблицы**: Все транзакции автоматически записываются в Google Таблицу для дальнейшего анализа с использованием асинхронного клиента.

6. **Обучение на основе ключевых слов**: Система запоминает ключевые слова для каждой категории, чтобы улучшить точность будущих распознаваний, включая биграммы и лемматизацию.

7. **Поддержка доходов и расходов**: Бот различает типы транзакций и позволяет вести учет как расходов, так и доходов.

8. **Валидация данных**: Проверка корректности вводимых данных (сумма, размер изображения и т.д.).

9. **Обработка ошибок**: Надежная обработка различных видов ошибок (сетевые, API, файловые).

10. **Многопользовательская поддержка**: Возможность ограничения доступа к боту определенным пользователям через список разрешенных ID.

11. **Local-First архитектура**: Транзакции сначала сохраняются в локальную SQLite базу данных, а затем синхронизируются с Google Sheets в фоновом режиме для обеспечения надежности и доступности данных даже при отсутствии интернета.

12. **FSM (Finite State Machine)**: Использование конечного автомата для управления сложными сценариями ввода транзакций с поддержкой черновиков и пошагового ввода.

13. **Умный ввод транзакций**: Возможность добавления транзакций через естественный язык (например, "кофе 300" или "такси 500") с автоматическим определением суммы и категории.

14. **История транзакций**: Просмотр предыдущих транзакций с пагинацией и возможностью фильтрации.

15. **Словарь ключевых слов**: Расширенная система хранения и поиска ключевых слов с поддержкой биграмм, коэффициентов уверенности и лемматизации для улучшения точности категоризации.

16. **Синхронизация в фоновом режиме**: Автоматическая синхронизация транзакций из локальной базы данных в Google Sheets с обработкой ошибок и повторными попытками при сбоях связи.

## Технологии

- Python 3.11+
- aiogram 3.x (асинхронный фреймворк для Telegram-ботов)
- Google Sheets API
- Proverkacheka.com API для распознавания чеков
- gspread и gspread-asyncio для работы с Google Sheets
- Pydantic v2 для валидации данных
- aiohttp для HTTP-запросов
- aiosqlite для асинхронной работы с SQLite
- pymorphy3 для лемматизации русского текста
- pytest и pytest-asyncio для тестирования